{% extends "base.html" %}

{% block title %}Preview Billing Records{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Preview Billing Records</h2>
    <div>
        <span class="badge bg-primary fs-6">{{ claims|length }} Records</span>
        <span class="badge bg-success fs-6">
            {{ claims|sum(attribute='days_count') }} Total Service Days
        </span>
    </div>
</div>

<div class="alert alert-info">
    <div class="row">
        <div class="col-md-4">
            <strong>File:</strong> {{ filename }}
        </div>
        <div class="col-md-4">
            <strong>Regional Center:</strong> <span class="badge bg-primary">{{ provider.regional_center }}</span> {{ provider.rc_name }}
        </div>
        <div class="col-md-4">
            <strong>Provider:</strong> {{ provider.name }}
        </div>
    </div>
    <small class="text-muted">Review the parsed data below. Click "Submit to eBilling" when ready.</small>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Consumer</th>
                <th>UCI #</th>
                <th>Auth #</th>
                <th>SVC Code</th>
                <th>Service Month</th>
                <th>Service Days</th>
                <th>Units</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for record in claims %}
            <tr>
                <td><strong>{{ record.consumer_name_display }}</strong></td>
                <td><code>{{ record.uci }}</code></td>
                <td>{{ record.auth_number }}</td>
                <td>
                    <code>{{ record.svc_code }}</code>
                    {% if record.svc_subcode %}/ <code>{{ record.svc_subcode }}</code>{% endif %}
                </td>
                <td>{{ record.service_month }}</td>
                <td>
                    <span class="badge bg-info">{{ record.days_count }} days</span>
                    <br>
                    <small class="text-muted">
                        {% for day in record.service_days %}{{ day }}{% if not loop.last %}, {% endif %}{% endfor %}
                    </small>
                </td>
                <td>{{ record.entered_units }}</td>
                <td>${{ "%.2f"|format(record.entered_amount) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="table-light">
            <tr>
                <td colspan="6" class="text-end"><strong>Total:</strong></td>
                <td><strong>{{ claims|sum(attribute='entered_units') }}</strong></td>
                <td><strong>${{ "%.2f"|format(claims|sum(attribute='entered_amount')) }}</strong></td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-lg w-100">
            Cancel / Upload Different File
        </a>
    </div>
    <div class="col-md-4">
        <button type="button" class="btn btn-info btn-lg w-100" id="inventoryBtn" onclick="getAvailableInvoices()">
            Get Available Invoices
        </button>
    </div>
    <div class="col-md-4">
        <button type="button" class="btn btn-success btn-lg w-100" id="submitBtn" onclick="submitClaims()">
            Submit to eBilling
        </button>
    </div>
</div>

<div id="inventoryStatus" class="alert alert-info mt-4 d-none">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        <span>Scanning portal for available invoices...</span>
    </div>
</div>

<div id="inventoryResults" class="mt-4 d-none">
    <div class="card">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Available Invoices on Portal</h5>
            <span id="inventoryCount" class="badge bg-light text-dark"></span>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <a id="inventoryDownloadLink" href="#" class="btn btn-sm btn-success">Download CSV</a>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th>Last Name</th>
                            <th>First Name</th>
                            <th>UCI</th>
                            <th>Service Month</th>
                            <th>SVC Code</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="submissionStatus" class="alert alert-info mt-4 d-none">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        <span>Processing submission...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const claimsData = {{ claims|tojson|safe }};
const providerId = {{ provider.id }};
// Get SPN ID from the first claim record
const spnId = claimsData.length > 0 ? claimsData[0].spn_id : null;

async function getAvailableInvoices() {
    const btn = document.getElementById('inventoryBtn');
    const status = document.getElementById('inventoryStatus');
    const results = document.getElementById('inventoryResults');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Scanning...';
    status.classList.remove('d-none');
    results.classList.add('d-none');

    try {
        const response = await fetch('{{ url_for("main.get_available_invoices_ajax") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                provider_id: providerId,
                spn_id: spnId
            })
        });

        const result = await response.json();

        status.classList.add('d-none');

        if (result.status === 'error') {
            status.classList.remove('d-none', 'alert-info');
            status.classList.add('alert-danger');
            status.innerHTML = `<strong>Error:</strong> ${result.message}`;
            btn.disabled = false;
            btn.innerHTML = 'Retry';
            return;
        }

        // Populate results table
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '';
        result.invoices.forEach(inv => {
            tbody.innerHTML += `
                <tr>
                    <td>${inv.last_name || ''}</td>
                    <td>${inv.first_name || ''}</td>
                    <td><code>${inv.uci || ''}</code></td>
                    <td>${inv.service_month || ''}</td>
                    <td><code>${inv.svc_code || ''}</code></td>
                </tr>`;
        });

        document.getElementById('inventoryCount').textContent = `${result.invoices.length} invoices`;
        document.getElementById('inventoryDownloadLink').href = '{{ url_for("main.download_available_invoices") }}';
        results.classList.remove('d-none');

        btn.disabled = false;
        btn.innerHTML = 'Refresh Invoices';
    } catch (error) {
        status.classList.remove('d-none', 'alert-info');
        status.classList.add('alert-danger');
        status.innerHTML = `<strong>Error:</strong> ${error.message}`;
        btn.disabled = false;
        btn.innerHTML = 'Retry';
    }
}

async function submitClaims() {
    const btn = document.getElementById('submitBtn');
    const status = document.getElementById('submissionStatus');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
    status.classList.remove('d-none');

    try {
        const response = await fetch('{{ url_for("main.submit_claims") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                claims: claimsData,
                provider_id: providerId
            })
        });

        const result = await response.json();

        if (result.status === 'error') {
            status.classList.remove('alert-info');
            status.classList.add('alert-danger');
            status.innerHTML = `<strong>Error:</strong> ${result.message}`;
            btn.disabled = false;
            btn.innerHTML = 'Retry Submission';
            return;
        }

        status.classList.remove('alert-info');
        status.classList.add('alert-success');

        let detailsHtml = '';
        if (result.results && result.results.length > 0) {
            detailsHtml = `
                <div class="table-responsive mt-3">
                    <table class="table table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Status</th>
                                <th>Consumer</th>
                                <th>UCI</th>
                                <th>SVC Code</th>
                                <th>Month</th>
                                <th>Days</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>`;

            result.results.forEach(r => {
                const rowClass = r.success ? 'table-success' : 'table-danger';
                const icon = r.success ? '✓' : '✗';
                const days = r.service_days ? r.service_days.join(', ') : (r.days_entered + ' days');
                const svcCode = (r.svc_code || '') + (r.svc_subcode ? '/' + r.svc_subcode : '');

                detailsHtml += `
                    <tr class="${rowClass}">
                        <td><strong>${icon}</strong></td>
                        <td>${r.consumer_name || ''}</td>
                        <td><code>${r.uci || ''}</code></td>
                        <td><code>${svcCode}</code></td>
                        <td>${r.service_month || ''}</td>
                        <td>${days}</td>
                        <td>${r.error || ''}</td>
                    </tr>`;
            });

            detailsHtml += '</tbody></table></div>';
        }

        status.innerHTML = `
            <strong>Complete!</strong> ${result.message}
            <br>Success: ${result.success_count} | Failed: ${result.failed_count}
            ${detailsHtml}
            <div class="mt-3">
                <a href="{{ url_for('main.download_report') }}" class="btn btn-primary">
                    Download Submission Report
                </a>
            </div>
        `;

        btn.classList.remove('btn-success');
        btn.classList.add('btn-secondary');
        btn.innerHTML = 'Submitted';
    } catch (error) {
        status.classList.remove('alert-info');
        status.classList.add('alert-danger');
        status.innerHTML = `<strong>Error:</strong> ${error.message}`;
        btn.disabled = false;
        btn.innerHTML = 'Retry Submission';
    }
}
</script>
{% endblock %}
