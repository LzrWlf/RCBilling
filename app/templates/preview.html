{% extends "base.html" %}

{% block title %}Preview Billing Records{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Preview Billing Records</h2>
    <div>
        <span class="badge bg-primary fs-6">{{ claims|length }} Records</span>
        <span class="badge bg-success fs-6">
            {{ claims|sum(attribute='days_count') }} Total Service Days
        </span>
    </div>
</div>

<div class="alert alert-info">
    <strong>File:</strong> {{ filename }}
    <br>
    <small>Review the parsed data below. Click "Submit to eBilling" when ready.</small>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Consumer</th>
                <th>UCI #</th>
                <th>Auth #</th>
                <th>SVC Code</th>
                <th>Service Month</th>
                <th>Service Days</th>
                <th>Units</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for record in claims %}
            <tr>
                <td>
                    <strong>{{ record.consumer_name_display }}</strong>
                </td>
                <td><code>{{ record.uci }}</code></td>
                <td>{{ record.auth_number }}</td>
                <td>
                    <code>{{ record.svc_code }}</code>
                    {% if record.svc_subcode %}
                    / <code>{{ record.svc_subcode }}</code>
                    {% endif %}
                </td>
                <td>{{ record.service_month }}</td>
                <td>
                    <span class="badge bg-info">{{ record.days_count }} days</span>
                    <br>
                    <small class="text-muted">
                        {% for day in record.service_days %}
                            {{ day }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </small>
                </td>
                <td>{{ record.entered_units }}</td>
                <td>${{ "%.2f"|format(record.entered_amount) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="table-light">
            <tr>
                <td colspan="6" class="text-end"><strong>Total:</strong></td>
                <td><strong>{{ claims|sum(attribute='entered_units') }}</strong></td>
                <td><strong>${{ "%.2f"|format(claims|sum(attribute='entered_amount')) }}</strong></td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-lg w-100">
            Cancel / Upload Different File
        </a>
    </div>
    <div class="col-md-6">
        <button type="button" class="btn btn-success btn-lg w-100" id="submitBtn" onclick="submitClaims()">
            Submit to eBilling
        </button>
    </div>
</div>

<div id="submissionStatus" class="alert alert-info mt-4 d-none">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        <span>Processing submission...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const claimsData = {{ claims|tojson|safe }};

async function submitClaims() {
    const btn = document.getElementById('submitBtn');
    const status = document.getElementById('submissionStatus');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
    status.classList.remove('d-none');

    try {
        const response = await fetch('{{ url_for("main.submit_claims") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ claims: claimsData })
        });

        const result = await response.json();

        if (result.status === 'error') {
            status.classList.remove('alert-info');
            status.classList.add('alert-danger');
            status.innerHTML = `<strong>Error:</strong> ${result.message}`;
            btn.disabled = false;
            btn.innerHTML = 'Retry Submission';
            return;
        }

        status.classList.remove('alert-info');
        status.classList.add('alert-success');

        let detailsHtml = '';
        if (result.results) {
            detailsHtml = '<ul class="mt-2 mb-0">';
            result.results.forEach(r => {
                const icon = r.success ? '✓' : '✗';
                const text = r.success
                    ? `${r.consumer_name} - ${r.days_entered} days entered`
                    : `${r.consumer_name} - ${r.error}`;
                detailsHtml += `<li>${icon} ${text}</li>`;
            });
            detailsHtml += '</ul>';
        }

        status.innerHTML = `
            <strong>Complete!</strong> ${result.message}
            <br>Success: ${result.success_count} | Failed: ${result.failed_count}
            ${detailsHtml}
            <div class="mt-3">
                <a href="{{ url_for('main.download_report') }}" class="btn btn-primary">
                    Download Submission Report
                </a>
            </div>
        `;

        btn.classList.remove('btn-success');
        btn.classList.add('btn-secondary');
        btn.innerHTML = 'Submitted';
    } catch (error) {
        status.classList.remove('alert-info');
        status.classList.add('alert-danger');
        status.innerHTML = `<strong>Error:</strong> ${error.message}`;
        btn.disabled = false;
        btn.innerHTML = 'Retry Submission';
    }
}
</script>
{% endblock %}
