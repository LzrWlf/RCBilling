{% extends "base.html" %}

{% block title %}Available Invoices - {{ provider.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Available Invoices - {{ provider.name }}</h4>
                <span class="badge bg-light text-dark">{{ invoices|length }} invoices found</span>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted">Provider: {{ provider.name }} ({{ provider.regional_center }})</span>
                    </div>
                    <div>
                        <a href="{{ url_for('main.download_available_invoices') }}" class="btn btn-success">
                            Download CSV
                        </a>
                        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary ms-2">
                            Back to Home
                        </a>
                    </div>
                </div>

                {% if invoices %}
                {% if scan_all and providers_scanned %}
                <div class="alert alert-info mb-3">
                    <strong>Providers scanned:</strong>
                    {% for p in providers_scanned %}
                    <span class="badge bg-secondary ms-1">{{ p.spn_id }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Invoice Summary Card -->
                <div class="card mb-4 border-primary" style="border-width: 2px;" id="invoiceSummaryCard">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Invoice Summary</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleSummary()">Hide/Show</button>
                    </div>
                    <div class="card-body p-0" id="invoiceSummaryBody">
                        <table class="table table-sm table-hover mb-0" id="summaryTable">
                            <thead class="table-secondary">
                                <tr>
                                    <th>Invoice #</th>
                                    <th class="text-center">Total Sub-Invoices</th>
                                    <th class="text-center">With Days Attended</th>
                                    <th class="text-center">With 0 Days Attended</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="invoiceTable">
                        <thead class="table-dark">
                            <tr>
                                {% if scan_all %}<th data-sort="provider_spn" class="sortable">Provider SPN <span class="sort-icon">⇅</span></th>{% endif %}
                                <th data-sort="last_name" class="sortable">Last Name <span class="sort-icon">⇅</span></th>
                                <th data-sort="first_name" class="sortable">First Name <span class="sort-icon">⇅</span></th>
                                <th data-sort="uci" class="sortable">UCI <span class="sort-icon">⇅</span></th>
                                <th data-sort="service_month" class="sortable">Service Month <span class="sort-icon">⇅</span></th>
                                <th data-sort="svc_code" class="sortable">Service Code <span class="sort-icon">⇅</span></th>
                                <th>SVC Subcode</th>
                                <th>Auth #</th>
                                <th>Auth Units</th>
                                <th>Invoice ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for inv in invoices %}
                            <tr data-provider="{{ inv.provider_spn or '' }}"
                                data-lastname="{{ inv.last_name }}"
                                data-firstname="{{ inv.first_name }}"
                                data-uci="{{ inv.uci }}"
                                data-month="{{ inv.service_month }}"
                                data-svc="{{ inv.svc_code }}"
                                data-invoiceid="{{ inv.invoice_id }}"
                                data-authunits="{{ inv.auth_units or '0' }}">
                                {% if scan_all %}<td><code>{{ inv.provider_spn or '' }}</code></td>{% endif %}
                                <td>{{ inv.last_name }}</td>
                                <td>{{ inv.first_name }}</td>
                                <td><code>{{ inv.uci }}</code></td>
                                <td>{{ inv.service_month }}</td>
                                <td>{{ inv.svc_code }}</td>
                                <td>{{ inv.svc_subcode }}</td>
                                <td><small>{{ inv.auth_number }}</small></td>
                                <td>{{ inv.auth_units }}</td>
                                <td><small class="text-muted">{{ inv.invoice_id }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    No invoices found on the portal for this provider.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    .sortable:hover {
        background-color: #495057;
    }
    .sort-icon {
        opacity: 0.5;
        margin-left: 5px;
    }
    .sortable.asc .sort-icon {
        opacity: 1;
    }
    .sortable.asc .sort-icon::after {
        content: ' ▲';
    }
    .sortable.desc .sort-icon {
        opacity: 1;
    }
    .sortable.desc .sort-icon::after {
        content: ' ▼';
    }
</style>

<script>
function toggleSummary() {
    const body = document.getElementById('invoiceSummaryBody');
    body.style.display = body.style.display === 'none' ? '' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    // Build invoice summary from the detail table rows
    const detailRows = document.querySelectorAll('#invoiceTable tbody tr');
    const invoiceGroups = {};

    detailRows.forEach(row => {
        const invId = row.dataset.invoiceid || '(No Invoice #)';
        const authUnits = parseFloat(row.dataset.authunits) || 0;
        if (!invoiceGroups[invId]) {
            invoiceGroups[invId] = { total: 0, withDays: 0, zeroDays: 0 };
        }
        invoiceGroups[invId].total++;
        // auth_units > 0 indicates days attended on the portal
        if (authUnits > 0) {
            invoiceGroups[invId].withDays++;
        } else {
            invoiceGroups[invId].zeroDays++;
        }
    });

    // Populate summary table
    const summaryBody = document.getElementById('summaryTableBody');
    if (summaryBody) {
        // Sort invoice IDs numerically
        const sortedIds = Object.keys(invoiceGroups).sort((a, b) => {
            const numA = parseInt(a) || Infinity;
            const numB = parseInt(b) || Infinity;
            return numA - numB;
        });

        sortedIds.forEach(invId => {
            const g = invoiceGroups[invId];
            const zeroClass = g.zeroDays > 0 ? 'table-warning' : '';
            const zeroBadge = g.zeroDays > 0
                ? `<span class="badge bg-danger">${g.zeroDays}</span>`
                : `<span class="badge bg-success">0</span>`;
            summaryBody.innerHTML += `
                <tr class="${zeroClass}">
                    <td><strong>${invId}</strong></td>
                    <td class="text-center">${g.total}</td>
                    <td class="text-center"><span class="badge bg-primary">${g.withDays}</span></td>
                    <td class="text-center">${zeroBadge}</td>
                </tr>`;
        });
    }

    const table = document.getElementById('invoiceTable');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    const tbody = table.querySelector('tbody');
    let currentSort = { column: null, direction: 'asc' };

    const dataMap = {
        'provider_spn': 'provider',
        'last_name': 'lastname',
        'first_name': 'firstname',
        'uci': 'uci',
        'service_month': 'month',
        'svc_code': 'svc'
    };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.dataset.sort;
            const dataAttr = dataMap[sortKey];

            if (currentSort.column === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortKey;
                currentSort.direction = 'asc';
            }

            headers.forEach(h => {
                h.classList.remove('asc', 'desc');
                h.querySelector('.sort-icon').textContent = '⇅';
            });
            this.classList.add(currentSort.direction);
            this.querySelector('.sort-icon').textContent = '';

            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                let valA = (a.dataset[dataAttr] || '').toLowerCase();
                let valB = (b.dataset[dataAttr] || '').toLowerCase();

                if (sortKey === 'uci' || sortKey === 'svc_code') {
                    const numA = parseInt(valA) || 0;
                    const numB = parseInt(valB) || 0;
                    if (numA !== numB) {
                        return currentSort.direction === 'asc' ? numA - numB : numB - numA;
                    }
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });
});
</script>
{% endblock %}
